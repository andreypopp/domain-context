// Generated by CoffeeScript 1.6.2
var domain;

domain = require('domain');

exports.requestContext = function(init, cleanup) {
  return function(req, res, next) {
    if (domain.active == null) {
      throw new Error('no active domain');
    }
    domain.active.__context__ = init();
    res.on('finish', function() {
      if (cleanup != null) {
        cleanup(domain.active.__context__);
      }
      return domain.active.__context__ = null;
    });
    return next();
  };
};

exports.requestContextOnError = function(cleanup) {
  return function(err, req, res, next) {
    if (domain.active == null) {
      throw new Error('no active domain');
    }
    if (cleanup != null) {
      clean(domain.active.__context__);
    }
    domain.active.__context__ = null;
    return next();
  };
};
